# Admin Panel JSON Upload Enhancement

## Overview

Enhanced the admin panel's question upload functionality to support JSON files generated by the Ultimate HTML Testbook Extractor script. This addition allows uploading comprehensive question data with HTML content preservation, multi-language support, and extensive metadata.

## New Features Added

### 1. JSON File Upload Support

- **File Format**: Added support for `.json` files alongside existing CSV and Excel formats
- **Input Validation**: Updated file input to accept `.json` files with proper validation
- **Error Handling**: Comprehensive error handling for JSON parsing and validation

### 2. HTML Extractor JSON Processing

- **Data Structure Support**: Full support for the Ultimate HTML Extractor JSON format
- **HTML Content Preservation**: Maintains original HTML formatting from questions, options, and solutions
- **Multi-language Processing**: Extracts English and Hindi content with automatic fallbacks
- **Image URL Extraction**: Automatically extracts and processes image URLs from HTML content

### 3. Enhanced UI/UX

#### Upload Dialog Improvements
- **Three-Tab Layout**: CSV, Excel, and JSON format tabs
- **JSON Format Tab**: Dedicated information about HTML Extractor format
- **Feature Highlights**: Visual indicators for supported features (HTML, Hindi, Images, etc.)
- **Usage Instructions**: Clear guidance on using the HTML Extractor script

#### JSON Preview System
- **File Summary**: Shows exam title, total questions, course, and sections
- **Question Preview**: Displays first 3 questions with key metadata
- **Feature Indicators**: Visual indicators for Hindi support, comprehension passages, etc.
- **Rich Display**: Better visualization of JSON data compared to table format

### 4. Data Processing Enhancements

#### Question Data Mapping
```javascript
// Enhanced question structure with comprehensive metadata
{
  // Basic question data
  question: cleanHtml(item.english?.questionHTML),
  type: item.features?.type,
  options: extractOptions(item.english?.optionsHTML),
  correctAnswer: convertLetterToIndex(item.correctAnswer),
  
  // Scoring information
  marks: item.properties?.scoring?.posMarks,
  negativeMark: item.properties?.scoring?.negMarks,
  
  // Multi-language content
  questionHindi: cleanHtml(item.hindi?.questionHTML),
  optionsHindi: extractOptions(item.hindi?.optionsHTML),
  
  // Rich content
  comprehensionPassage: cleanHtml(item.english?.comprehensionHTML),
  solution: cleanHtml(item.english?.solutionHTML),
  
  // Extracted metadata
  extractorMetadata: {
    originalQuestionId: item.questionId,
    sectionTitle: item.sectionTitle,
    features: item.features,
    properties: item.properties,
    // ... additional metadata
  }
}
```

#### HTML Processing
- **Entity Conversion**: Converts HTML entities back to proper format (&lt; → <, etc.)
- **Content Sanitization**: Removes dangerous scripts while preserving formatting
- **Text Extraction**: Provides both HTML and text versions of content
- **Image URL Processing**: Converts relative URLs to absolute URLs for Google Storage

### 5. Metadata Preservation

#### Question Features
- **Question Type**: MCQ, multiple choice, numerical, etc.
- **Special Features**: Speed challenge, personality test, comprehension type
- **Language Support**: Available languages and content analysis
- **Scoring Patterns**: Positive marks, negative marks, partial marking

#### Comprehensive Properties
- **Core Properties**: ID, type, numerical flag
- **Scoring Properties**: Marking scheme details
- **Navigation Properties**: Section and question numbering
- **Comprehension Properties**: Passage information and question ranges

## Technical Implementation

### New Functions Added

1. **`processHtmlExtractorJson(jsonData)`**
   - Processes the complete JSON structure from HTML extractor
   - Maps extractor format to internal question format
   - Handles multi-language content extraction

2. **`extractImageUrl(html)`**
   - Extracts image URLs from HTML content
   - Converts relative URLs to absolute URLs
   - Handles Google Storage URL formats

3. **`previewJsonFile(file)`**
   - Generates JSON file preview with summary information
   - Creates question preview data for UI display
   - Validates JSON structure and format

4. **`processAndUploadJson(file)`**
   - Complete JSON file processing pipeline
   - Error handling and validation
   - Integration with existing upload system

### Enhanced Functions

1. **`handleFileChange()`**
   - Added JSON file type detection
   - Updated error messages and validation
   - Added JSON preview triggering

2. **Upload Dialog UI**
   - Added JSON format tab with comprehensive information
   - Enhanced preview system with format-specific displays
   - Updated file input accept attribute

## Usage Instructions

### For Administrators

1. **Navigate to Admin Panel**: Go to Admin → Questions
2. **Click Upload**: Select "Bulk Upload Questions"
3. **Choose JSON Tab**: Select the "JSON Format" tab
4. **Upload File**: Select a JSON file generated by the HTML Extractor
5. **Review Preview**: Check the file summary and question preview
6. **Select Exam & Subject**: Choose target exam and subject
7. **Upload**: Click "Upload Questions" to import

### For HTML Extractor Users

1. **Run Extractor**: Use the Ultimate HTML Testbook Extractor script on Testbook exam pages
2. **Export JSON**: Use `htmlExtractor.exportToJSON()` to download the complete data file
3. **Upload to Admin**: Use the downloaded JSON file in the admin panel
4. **Verify Data**: Review the preview to ensure all data was captured correctly

## Supported JSON Structure

The system expects JSON files with this structure:
```json
{
  "examDetails": {
    "title": "Exam Title",
    "course": "Course Name",
    "totalQuestions": 100,
    "totalSections": 4
  },
  "questions": [
    {
      "questionNo": 1,
      "sectionTitle": "Section Name",
      "questionId": "unique_id",
      "correctAnswer": "C",
      "english": {
        "questionHTML": "<p>Question content...</p>",
        "optionsHTML": [
          {"label": "A", "html": "Option A"},
          {"label": "B", "html": "Option B"},
          {"label": "C", "html": "Option C"},
          {"label": "D", "html": "Option D"}
        ],
        "solutionHTML": "<p>Solution explanation...</p>",
        "comprehensionHTML": "<p>Passage content...</p>"
      },
      "hindi": {
        // Similar structure for Hindi content
      },
      "properties": {
        "scoring": {
          "posMarks": 2,
          "negMarks": 0.5
        }
      },
      "features": {
        "type": "mcq",
        "hasComprehension": false,
        "isNumerical": false
      }
    }
  ]
}
```

## Benefits

1. **Rich Content Support**: Preserves HTML formatting, images, and complex layouts
2. **Time Saving**: Bulk import of properly formatted questions with metadata
3. **Multi-language Ready**: Automatic handling of English and Hindi content
4. **Comprehensive Data**: Imports scoring, features, and metadata automatically
5. **Quality Preservation**: Maintains original question quality and formatting
6. **Flexibility**: Works alongside existing CSV/Excel upload methods

## Future Enhancements

1. **Image Upload**: Automatic image downloading and re-hosting
2. **Batch Processing**: Support for multiple JSON files
3. **Custom Field Mapping**: Configurable field mapping for different extractors
4. **Validation Rules**: Enhanced validation for different question types
5. **Preview Export**: Export preview data for verification before upload

## Error Handling

The system provides comprehensive error handling for:
- Invalid JSON format
- Missing required fields
- Invalid question structure
- Subject ID validation
- File size limitations
- Upload failures with detailed error messages

## Testing

To test the new functionality:
1. Use the provided sample JSON file: `scripts/SSC_CGL_2024_Tier-I_Official_Paper_(Held_On_09_Sept,_2024_Shift_2)_complete_data.json`
2. Create an exam and subject in the admin panel
3. Upload the JSON file using the new JSON format tab
4. Verify that questions are imported with proper formatting and metadata
